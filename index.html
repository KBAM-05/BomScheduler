<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리아이 맞춤 주간 스케줄러 v2.1</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #FDFBF8; color: #4A4A4A; }
        .timeline-item { position: relative; padding-left: 2rem; display: flex; align-items: flex-start; gap: 1rem; }
        .timeline-item::before { content: ''; position: absolute; left: 1.25rem; top: 1.25rem; bottom: -1.25rem; width: 2px; background-color: #EAEAEA; transform: translateX(-50%); }
        .timeline-item:last-child::before { display: none; }
        .tab-active { background-color: #A4C3B2; color: white; font-weight: 700; }
        .tab-inactive { background-color: #F0F0F0; color: #6B7280; }
        .analysis-tab-active { background-color: #5F9EA0; color: white; font-weight: 700; }
        .analysis-tab-inactive { background-color: #E0F2F7; color: #3B666B; }
        .current-activity { background-color: #FFFBEB; border-left-color: #F59E0B !important; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); z-index: 10; }
        .completed-activity .activity-text { text-decoration: line-through; color: #9CA3AF; }
        #schedule-content { max-height: 500px; overflow-y: auto; padding-right: 10px; }
        #editModal.hidden, #management-overlay.hidden { display: none; }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl sm:text-4xl font-bold text-[#3B666B] mb-2">우리아이 맞춤 주간 스케줄러 v2.1</h1>
            <p class="text-lg text-gray-600">아이의 하루를 사랑과 계획으로 채워주세요</p>
            <button id="manage-schedule-btn" title="전체 일정 관리" class="absolute top-0 right-0 bg-white p-3 rounded-full shadow-md hover:bg-gray-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </header>

        <main class="lg:grid lg:grid-cols-3 lg:gap-8">
            <div class="lg:col-span-2">
                <section id="daily-schedule" class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                    <h2 class="text-2xl font-bold text-[#3B666B] mb-4">오늘의 일정</h2>
                    <p class="text-gray-600 mb-6">현재 시간을 기준으로 오늘 해야 할 활동을 확인하고, 완료 시 체크박스를 눌러주세요.</p>
                    <div id="day-tabs" class="flex flex-wrap gap-2 mb-6"></div>
                    <div id="schedule-content" class="space-y-6"></div>
                </section>
                <section id="analysis-section" class="bg-white p-6 rounded-2xl shadow-lg h-full">
                    <h2 class="text-2xl font-bold mb-4 text-[#3B666B]">활동 분석</h2>
                    <div class="flex gap-2 mb-4">
                        <button id="weekly-analysis-tab" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 analysis-tab-active">주간</button>
                        <button id="daily-analysis-tab" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 analysis-tab-inactive">일간</button>
                    </div>
                    <div id="weekly-analysis-content"><div class="chart-container"><canvas id="weeklyActivityChart"></canvas></div></div>
                    <div id="daily-analysis-content" class="hidden"><div class="chart-container"><canvas id="dailyActivityChart"></canvas></div></div>
                </section>
            </div>
            <div class="lg:col-span-1 mt-8 lg:mt-0">
                <section id="explore-schedule-section" class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                    <h2 class="text-2xl font-bold mb-4 text-[#3B666B]">요일별 스케줄 탐색</h2>
                    <div id="explore-day-tabs" class="flex flex-wrap gap-2 mb-6"></div>
                    <div id="schedule-content-explore" class="space-y-4"></div>
                </section>
            </div>
        </main>
    </div>

    <div id="management-overlay" class="hidden fixed inset-0 bg-white z-50 p-4 sm:p-8 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-[#3B666B]">전체 일정 관리</h2><button id="close-management-btn" class="text-3xl text-gray-500 hover:text-gray-800">&times;</button></div>
            <div id="management-content" class="space-y-8"></div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[60] p-4">
        <div class="bg-white p-6 rounded-lg w-full max-w-md shadow-xl max-h-full overflow-y-auto">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4"></h3>
            <input type="hidden" id="modalDay"><input type="hidden" id="modalIndex">
            <div class="space-y-4">
                <div><label for="modalTime" class="block text-sm font-medium text-gray-700">시간</label><input type="time" id="modalTime" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="modalActivity" class="block text-sm font-medium text-gray-700">활동 이름</label><input type="text" id="modalActivity" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="modalDescription" class="block text-sm font-medium text-gray-700">설명</label><textarea id="modalDescription" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea></div>
                <div><label for="modalCategory" class="block text-sm font-medium text-gray-700">카테고리</label><select id="modalCategory" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select></div>
                <div><label for="modalIcon" class="block text-sm font-medium text-gray-700">아이콘</label><input type="text" id="modalIcon" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
            </div>
            <div class="mt-6 flex justify-end gap-3"><button id="cancelButton" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md">취소</button><button id="saveButton" class="px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-md">저장</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let scheduleData = {};
            const categoryColors = { '치료': '#FF7F50', '학습': '#6495ED', '독서': '#8A2BE2', '놀이': '#3CB371', '휴식': '#FFD700', '기본생활': '#A9A9A9', '외부수업': '#DC143C' };
            const defaultSchedule = {
                '월': [{ time: '17:00', activity: '집 도착, 휴식 및 자유 놀이', description: '간식을 먹고, 아이가 원하는 놀이를 하며 편안한 시간을 보내요.', category: '휴식', icon: '🏠' }, { time: '17:30', activity: '개별 학습: 한글', description: '매일 꾸준히 한글을 익히는 시간이에요.', category: '학습', icon: '📚' }, { time: '18:00', activity: '저녁 식사 준비 돕기', description: '식사 준비를 도우며 책임감을 길러요.', category: '기본생활', icon: '🍽️' }, { time: '18:30', activity: '저녁 식사', description: '온 가족이 함께 즐거운 식사 시간을 가져요.', category: '기본생활', icon: '🍽️' }, { time: '19:30', activity: '함께 책 읽기', description: '아이의 상상력을 자극하는 재미있는 책을 함께 읽어요.', category: '독서', icon: '📖' }, { time: '20:00', activity: '자유 놀이 및 휴식', description: '아이가 좋아하는 활동으로 하루를 즐겁게 마무리해요.', category: '놀이', icon: '🎉' }, { time: '21:00', activity: '내일 준비물 챙기기', description: '내일 필요한 물건들을 미리 챙겨요.', category: '기본생활', icon: '🎒' }, { time: '21:30', activity: '취침 준비', description: '내일을 위해 차분하게 잠자리에 들 준비를 해요.', category: '기본생활', icon: '씻기' }, ],
                '화': [{ time: '17:00', activity: '집 도착, 간식 및 휴식', description: '학교 다녀온 후 충분히 쉬는 시간을 가져요.', category: '휴식', icon: '🏠' }, { time: '17:30', activity: '음악 감상 및 리듬 놀이', description: '다양한 음악을 듣고 리듬을 느껴봐요.', category: '놀이', icon: '🎶' }, { time: '18:00', activity: '개별 학습: 수학', description: '숫자와 도형을 재미있게 배워요.', category: '학습', icon: '📚' }, { time: '18:30', activity: '저녁 식사', description: '맛있는 저녁을 먹으며 도란도란 이야기해요.', category: '기본생활', icon: '🍽️' }, { time: '19:30', activity: '한글/수학 수업 (외부)', description: '외부 수업에 참여하며 새로운 것을 배워요.', category: '외부수업', icon: '🏫' }, { time: '20:30', activity: '수업 후 휴식 및 자유 놀이', description: '수업으로 지친 몸과 마음을 쉬게 해줘요.', category: '놀이', icon: '🎉' }, { time: '21:00', activity: '내일 학습 준비물 확인', description: '내일 필요한 학습 도구를 확인해요.', category: '기본생활', icon: '📝' }, { time: '21:30', activity: '취침 준비', description: '내일을 위해 차분하게 잠자리에 들 준비를 해요.', category: '기본생활', icon: '씻기' }, ],
                '수': [{ time: '16:30', activity: '통합 감각 치료 (외부)', description: '치료를 통해 다양한 감각을 경험하고 발달시켜요.', category: '치료', icon: '?' }, { time: '17:30', activity: '집 도착 및 휴식', description: '치료 후 집에 와서 편안하게 쉬어요.', category: '휴식', icon: '🏠' }, { time: '18:00', activity: '개별 학습: 영어 단어', description: '재미있는 그림과 함께 영어 단어를 익혀요.', category: '학습', icon: '📚' }, { time: '18:30', activity: '저녁 식사', description: '에너지를 보충하는 즐거운 저녁 시간이에요.', category: '기본생활', icon: '🍽️' }, { time: '19:30', activity: '가족과 함께 보드게임', description: '보드게임을 하며 가족과 즐거운 시간을 보내요.', category: '놀이', icon: '🎲' }, { time: '20:10', activity: '함께 책 읽기 또는 가벼운 놀이', description: '차분한 활동으로 하루를 정리해요.', category: '독서', icon: '📖' }, { time: '21:00', activity: '개인 위생 관리', description: '양치, 세수 등 스스로 위생을 관리해요.', category: '기본생활', icon: '🪥' }, { time: '21:30', activity: '취침 준비', description: '내일을 위해 차분하게 잠자리에 들 준비를 해요.', category: '기본생활', icon: '씻기' }, ],
                '목': [{ time: '16:00', activity: '인지 치료 (외부)', description: '생각하는 힘을 기르는 즐거운 치료 시간이에요.', category: '치료', icon: '🧠' }, { time: '17:00', activity: '집 도착 및 휴식', description: '치료 후 집에 와서 편안하게 쉬어요.', category: '휴식', icon: '🏠' }, { time: '17:30', activity: '미술 활동', description: '크레용, 물감으로 자유롭게 표현해요.', category: '놀이', icon: '🎨' }, { time: '18:00', activity: '개별 학습: 과학 탐구', description: '간단한 과학 실험으로 호기심을 키워요.', category: '학습', icon: '🔬' }, { time: '18:30', activity: '저녁 식사', description: '맛있는 저녁으로 에너지를 채워요.', category: '기본생활', icon: '🍽️' }, { time: '19:30', activity: '한글/수학 수업 (외부)', description: '외부 수업을 통해 즐겁게 배워요.', category: '외부수업', icon: '🏫' }, { time: '20:30', activity: '자유 놀이 시간', description: '아이가 원하는 놀이를 하며 마음껏 상상력을 펼쳐요.', category: '놀이', icon: '🎉' }, { time: '21:00', activity: '옷 정리하기', description: '벗은 옷을 스스로 정리하는 연습을 해요.', category: '기본생활', icon: '👕' }, { time: '21:30', activity: '취침 준비', description: '내일을 위해 차분하게 잠자리에 들 준비를 해요.', category: '기본생활', icon: '씻기' }, ],
                '금': [{ time: '17:00', activity: '사회성 수업 (외부)', description: '친구들과 어울리는 방법을 배우는 시간이에요.', category: '치료', icon: '🧑‍🤝‍🧑' }, { time: '18:00', activity: '키즈카페에서 신나게 놀기', description: '에너지를 발산하며 즐거운 시간을 보내요.', category: '놀이', icon: '🤸' }, { time: '19:00', activity: '간식 및 자유시간', description: '신나게 놀고 와서 간단한 간식을 먹어요.', category: '휴식', icon: '🍎' }, { time: '19:30', activity: '집 도착 및 저녁 식사', description: '신나게 놀고 와서 먹는 저녁은 꿀맛이에요.', category: '기본생활', icon: '🍽️' }, { time: '20:30', activity: '함께 책 읽기 또는 가벼운 활동', description: '흥분된 마음을 가라앉히고 차분하게 하루를 마무리해요.', category: '독서', icon: '📖' }, { time: '21:00', activity: '주말 계획 이야기하기', description: '주말에 무엇을 할지 함께 이야기 나눠요.', category: '놀이', icon: '🗓️' }, { time: '21:30', activity: '취침 준비', description: '내일을 위해 차분하게 잠자리에 들 준비를 해요.', category: '기본생활', icon: '씻기' }, ],
                '주말': [{ time: '09:00', activity: '기상 및 아침 식사', description: '주말 아침, 상쾌하게 시작해요!', category: '기본생활', icon: '☀️' }, { time: '10:00', activity: '짧은 1:1 학습 (30-40분)', description: '주중에 부족했던 부분을 재미있는 놀이처럼 학습해요.', category: '학습', icon: '📚' }, { time: '10:40', activity: '함께 책 읽기', description: '흥미로운 이야기를 함께 읽으며 상상력을 키워요.', category: '독서', icon: '📖' }, { time: '11:30', activity: '자유 놀이 또는 야외 활동', description: '아이가 좋아하는 놀이를 하거나, 가까운 공원에서 신체 활동을 즐겨요.', category: '놀이', icon: '🪁' }, { time: '12:30', activity: '점심 식사', description: '맛있는 점심을 먹고 에너지를 충전해요.', category: '기본생활', icon: '🍽️' }, { time: '14:00', activity: '부모님과 특별 활동/치료 훈련', description: '아이에게 필요한 맞춤형 훈련(소근육, 인지, 언어 등)을 놀이처럼 진행하거나, 함께 특별한 활동을 해요.', category: '치료', icon: '🧩' }, { time: '15:00', activity: '자유 놀이 및 간식', description: '활동 후 자유롭게 놀며 간식을 먹어요.', category: '놀이', icon: '🍦' }, { time: '16:00', activity: '집 안 정리 돕기', description: '장난감이나 책을 정리하며 청결 습관을 길러요.', category: '기본생활', icon: '🧹' }, { time: '17:00', activity: '가족과 함께하는 시간', description: '보드게임, 영화 보기, 대화 등 가족과 즐거운 시간을 보내요.', category: '놀이', icon: '👨‍👩‍👧‍👦' }, { time: '18:00', activity: '하루 일과 돌아보기', description: '오늘 무엇을 했는지 이야기 나누며 하루를 마무리해요.', category: '독서', icon: '💬' }, { time: '18:30', activity: '저녁 식사', description: '주말 저녁은 특별한 메뉴로 즐겁게!', category: '기본생활', icon: '🍜' }, { time: '19:30', activity: '다음 주간 스케줄 미리 보기', description: '다음 주 스케줄을 미리 보며 새로운 한 주를 준비해요.', category: '학습', icon: '📅' }, { time: '20:00', activity: '휴식 및 취침 준비', description: '하루를 마무리하며 편안하게 쉬고 잠자리에 들 준비를 해요.', category: '기본생활', icon: '씻기' }]
            };
            const scheduleContent = document.getElementById('schedule-content');
            const dayTabsContainer = document.getElementById('day-tabs');
            const exploreDayTabsContainer = document.getElementById('explore-day-tabs');
            const exploreScheduleContent = document.getElementById('schedule-content-explore');
            const managementOverlay = document.getElementById('management-overlay');
            const managementContent = document.getElementById('management-content');
            const modal = document.getElementById('editModal');
            let currentActiveDay = '월';

            // --- 데이터 관리 함수 ---
            function loadScheduleState() {
                const savedData = localStorage.getItem('childScheduleData_v2.1');
                if (savedData) { scheduleData = JSON.parse(savedData); } 
                else {
                    Object.keys(defaultSchedule).forEach(day => {
                        scheduleData[day] = defaultSchedule[day].map(activity => ({...activity, description: activity.description || '', completed: false, notified_5min: false, notified_start: false}));
                    });
                }
            }
            function saveScheduleState() { localStorage.setItem('childScheduleData_v2.1', JSON.stringify(scheduleData)); }
            function timeToMinutes(timeStr) { if (!timeStr || !timeStr.includes(':')) return 0; const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; }
            function formatTimeForDisplay(timeStr) { if (!timeStr || !timeStr.includes(':')) return timeStr; let [h, m] = timeStr.split(':'); const ampm = h >= 12 ? '오후' : '오전'; h = h % 12 || 12; return `${ampm} ${h}:${m}`; }
            async function setupAudio() { /* 이전과 동일 */ }
            function playClapSound() { /* 이전과 동일 */ }

            // --- 일정 편집/관리 함수 ---
            function openModal(day, index = -1) {
                document.getElementById('modalDay').value = day;
                document.getElementById('modalIndex').value = index;
                document.getElementById('modalCategory').innerHTML = Object.keys(categoryColors).map(cat => `<option value="${cat}">${cat}</option>`).join('');
                if (index === -1) {
                    document.getElementById('modalTitle').textContent = `${day} 새 일정 추가`;
                    document.getElementById('modalTime').value = '';
                    document.getElementById('modalActivity').value = '';
                    document.getElementById('modalDescription').value = '';
                    document.getElementById('modalCategory').value = '기본생활';
                    document.getElementById('modalIcon').value = '📝';
                } else {
                    document.getElementById('modalTitle').textContent = `${day} 일정 수정`;
                    const activity = scheduleData[day][index];
                    document.getElementById('modalTime').value = activity.time;
                    document.getElementById('modalActivity').value = activity.activity;
                    document.getElementById('modalDescription').value = activity.description || '';
                    document.getElementById('modalCategory').value = activity.category;
                    document.getElementById('modalIcon').value = activity.icon;
                }
                modal.classList.remove('hidden');
            }
            function closeModal() { modal.classList.add('hidden'); }
            function saveActivity() {
                const day = document.getElementById('modalDay').value;
                const index = parseInt(document.getElementById('modalIndex').value, 10);
                const newActivity = {
                    time: document.getElementById('modalTime').value,
                    activity: document.getElementById('modalActivity').value.trim(),
                    description: document.getElementById('modalDescription').value.trim(),
                    category: document.getElementById('modalCategory').value,
                    icon: document.getElementById('modalIcon').value.trim() || '📝',
                    completed: index === -1 ? false : scheduleData[day][index].completed,
                    notified_5min: false, notified_start: false
                };
                if (!newActivity.time || !newActivity.activity) { alert('시간과 활동 이름은 필수 항목입니다.'); return; }
                if (index === -1) { scheduleData[day].push(newActivity); } 
                else { scheduleData[day][index] = newActivity; }
                scheduleData[day].sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));
                saveScheduleState();
                renderAll();
                closeModal();
            }
            function deleteActivity(day, index) {
                if (confirm(`'${scheduleData[day][index].activity}' 일정을 정말 삭제하시겠습니까?`)) {
                    scheduleData[day].splice(index, 1);
                    saveScheduleState();
                    renderAll();
                }
            }

            // --- UI 렌더링 함수 ---
            function createScheduleItemHtml(item) {
                const borderColor = categoryColors[item.category] || 'border-gray-200';
                const completedClass = item.completed ? 'completed-activity' : '';
                const checkboxHtml = `<input type="checkbox" data-action="check" class="activity-checkbox h-5 w-5 text-teal-600 rounded" ${item.completed ? 'checked' : ''}>`;
                return `<div class="relative flex items-start gap-4 timeline-item border-l-4 ${borderColor} pl-6 pr-4 py-3 rounded-lg ${completedClass}" data-activity-time="${item.time}"><div class="absolute -left-3.5 top-5 -translate-y-1/2 flex items-center justify-center w-8 h-8 rounded-full bg-white ring-4 ring-[#A4C3B2]"><span class="text-2xl">${item.icon}</span></div><div class="pt-1.5">${checkboxHtml}</div><div class="flex-1 activity-text"><p class="text-sm text-gray-500">${formatTimeForDisplay(item.time)}</p><h3 class="font-bold text-lg text-gray-800">${item.activity}</h3><p class="text-gray-600 text-sm">${item.description || ''}</p></div></div>`;
            }

            function renderSchedule(day) {
                scheduleContent.innerHTML = (scheduleData[day] || []).map(createScheduleItemHtml).join('');
            }
            
            function renderTabs() {
                const days = Object.keys(scheduleData);
                const todayIndex = new Date().getDay();
                let systemDay = { 0: '주말', 1: '월', 2: '화', 3: '수', 4: '목', 5: '금', 6: '주말' }[todayIndex];
                currentActiveDay = scheduleData[systemDay] ? systemDay : '월';
                
                const tabHtml = days.map(day => `<button data-day="${day}" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 ${day === currentActiveDay ? 'tab-active' : 'tab-inactive'}">${day}</button>`).join('');
                dayTabsContainer.innerHTML = tabHtml;
                exploreDayTabsContainer.innerHTML = tabHtml.replaceAll('tab-active', 'tab-inactive');
            }

            function renderManagementView() {
                managementContent.innerHTML = Object.keys(scheduleData).map(day => `
                    <div>
                        <h3 class="text-xl font-bold text-teal-700 bg-teal-50 p-3 rounded-t-lg">${day}</h3>
                        <div class="border rounded-b-lg">
                            ${scheduleData[day].map((item, index) => `
                                <div class="flex items-center justify-between p-3 border-b last:border-b-0">
                                    <div class="flex items-center gap-3"><span class="font-semibold text-gray-700 w-20">${formatTimeForDisplay(item.time)}</span><span>${item.activity}</span></div>
                                    <div class="flex gap-2"><button data-action="edit" data-day="${day}" data-index="${index}" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded">수정</button><button data-action="delete" data-day="${day}" data-index="${index}" class="text-sm bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-1 px-3 rounded">삭제</button></div>
                                </div>
                            `).join('') || `<p class="p-3 text-gray-500">일정이 없습니다.</p>`}
                        </div>
                        <div class="text-center mt-2"><button data-action="add" data-day="${day}" class="w-full bg-green-100 hover:bg-green-200 text-green-800 font-semibold py-2 px-4 rounded-lg transition-colors">+ 이 요일에 일정 추가</button></div>
                    </div>
                `).join('');
            }

            function renderAll() {
                renderTabs();
                renderSchedule(currentActiveDay);
                // 여기에 다른 렌더링 함수들(차트 등)을 호출할 수 있습니다.
            }

            function updateCurrentActivityHighlight() {
                 document.querySelectorAll('#schedule-content .timeline-item').forEach(el => el.classList.remove('current-activity'));
                 const nowMinutes = new Date().getHours() * 60 + new Date().getMinutes();
                 const currentSchedule = scheduleData[currentActiveDay] || [];
                 let currentActivityTime = null;
                 for (let i = 0; i < currentSchedule.length; i++) {
                     if (currentSchedule[i].completed) continue;
                     if (timeToMinutes(currentSchedule[i].time) <= nowMinutes) {
                         currentActivityTime = currentSchedule[i].time;
                     } else { break; }
                 }
                 if (currentActivityTime) {
                     const el = document.querySelector(`#schedule-content .timeline-item[data-activity-time="${currentActivityTime}"]`);
                     if (el) {
                         el.classList.add('current-activity');
                         el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     }
                 }
            }
            
            // --- 앱 초기화 및 이벤트 리스너 ---
            function initializeApp() {
                loadScheduleState(); 
                setupAudio(); 
                renderAll();
                updateCurrentActivityHighlight();

                // 이벤트 위임(Event Delegation)으로 이벤트 리스너 설정
                scheduleContent.addEventListener('click', e => {
                    if (e.target.dataset.action === 'check') {
                        const time = e.target.closest('.timeline-item').dataset.activityTime;
                        const activity = scheduleData[currentActiveDay].find(item => item.time === time);
                        if(activity) {
                            activity.completed = e.target.checked;
                            saveScheduleState();
                            e.target.closest('.timeline-item').classList.toggle('completed-activity', activity.completed);
                            if (activity.completed) playClapSound();
                        }
                    }
                });
                dayTabsContainer.addEventListener('click', e => {
                    const day = e.target.dataset.day;
                    if (day) {
                        currentActiveDay = day;
                        renderAll();
                        updateCurrentActivityHighlight();
                    }
                });
                managementContent.addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const { action, day, index } = button.dataset;
                    if (action === 'add') openModal(day);
                    if (action === 'edit') openModal(day, parseInt(index));
                    if (action === 'delete') deleteActivity(day, parseInt(index));
                });
                document.getElementById('manage-schedule-btn').addEventListener('click', () => { renderManagementView(); managementOverlay.classList.remove('hidden'); });
                document.getElementById('close-management-btn').addEventListener('click', () => { managementOverlay.classList.add('hidden'); });
                document.getElementById('saveButton').addEventListener('click', saveActivity);
                document.getElementById('cancelButton').addEventListener('click', closeModal);

                setInterval(() => { updateCurrentActivityHighlight(); }, 60000); 
            }

            initializeApp();
        });
    </script>
</body>
</html>